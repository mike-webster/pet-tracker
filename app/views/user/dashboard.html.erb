<script>
  $(document).ready(function () {
    function updatePanel(petId) {
      var panel = $("#pet-info");
      var req = new XMLHttpRequest();
      req.open( "GET", "/pet/" + petId + "/events", false ); // false for synchronous request
      req.send( null );
      
      panel.html(req.responseText);

      panel.show(); 
      $(".event_form").show();
      $(".charts").show();
    }

    function setSelectedPet(petId) {
      $("[name='event[pet_id]']").val(petId);
    }

    function submitEventForm() {      
      var spinner = '<div class="spinner-grow" role="status"><span class="sr-only">Loading...</span></div>'
      $('.event_form').prepend(spinner);

      $.ajax({
        url: $('form').attr('action'),
        type: "POST",
        data: $('form').serialize(),
        success: function(data, status, jqxhr) {
          console.log('submit success');
          $('.spinner-grow').hide();
          updatePanel($('#pets').value);
        },
        error: function(jqxhr, status, err) {
          console.log(err);
          $('.spinner-grow').hide();
        }
      });
    }

    function getChart(id, type) {
      $.ajax({
        url: "/pet/" + id + "/graph/" + type,
        type: "GET",
        success: function(data, status, jqxhr) {
          //return data;
          $('#pet-chart').html(data);
        },
        error: function(jqxhr, status, err) {
          console.log("error: " + err);
        }
      });
    }

    $('#pets').on('change', function() {
      updatePanel(this.value);
      setSelectedPet(this.value);
      getChart(this.value, "potties-html");
    });

    $('form').submit(function(e){
      e.preventDefault();
      submitEventForm();
      return false; // prevent default action
    });

    $('.nav-tab').click(function(e){
      e.preventDefault();
      $('.nav-tab').removeClass('active');
      $('#' + this.id).addClass('active');

      var type = this.id.replace("-tab", "-html");
      getChart($("#pets").val(), type);
    });
  });
</script>

<style>

  .panel.with-nav-tabs .panel-heading{
      padding: 5px 5px 0 5px;
  }
  .panel.with-nav-tabs .nav-tabs{
    border-bottom: none;
  }
  .panel.with-nav-tabs .nav-justified{
    margin-bottom: -1px;
  }
  /********************************************************************/
  /*** PANEL DEFAULT ***/
  .with-nav-tabs.panel-default .nav-tabs > li > a,
  .with-nav-tabs.panel-default .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > li > a:focus {
      color: #777;
  }
  .with-nav-tabs.panel-default .nav-tabs > .open > a,
  .with-nav-tabs.panel-default .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-default .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > li > a:focus {
      color: #777;
    background-color: #ddd;
    border-color: transparent;
  }
  .with-nav-tabs.panel-default .nav-tabs > li.active > a,
  .with-nav-tabs.panel-default .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > li.active > a:focus {
    color: #555;
    background-color: #fff;
    border-color: #ddd;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #f5f5f5;
      border-color: #ddd;
  }
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #777;   
  }
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #ddd;
  }
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-default .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      color: #fff;
      background-color: #555;
  }
  /********************************************************************/
  /*** PANEL PRIMARY ***/
  .with-nav-tabs.panel-primary .nav-tabs > li > a,
  .with-nav-tabs.panel-primary .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > li > a:focus {
      color: #fff;
  }
  .with-nav-tabs.panel-primary .nav-tabs > .open > a,
  .with-nav-tabs.panel-primary .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-primary .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > li > a:focus {
    color: #fff;
    background-color: #3071a9;
    border-color: transparent;
  }
  .with-nav-tabs.panel-primary .nav-tabs > li.active > a,
  .with-nav-tabs.panel-primary .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > li.active > a:focus {
    color: #428bca;
    background-color: #fff;
    border-color: #428bca;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #428bca;
      border-color: #3071a9;
  }
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #fff;   
  }
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #3071a9;
  }
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-primary .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      background-color: #4a9fe9;
  }
  /********************************************************************/
  /*** PANEL SUCCESS ***/
  .with-nav-tabs.panel-success .nav-tabs > li > a,
  .with-nav-tabs.panel-success .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > li > a:focus {
    color: #3c763d;
  }
  .with-nav-tabs.panel-success .nav-tabs > .open > a,
  .with-nav-tabs.panel-success .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-success .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > li > a:focus {
    color: #3c763d;
    background-color: #d6e9c6;
    border-color: transparent;
  }
  .with-nav-tabs.panel-success .nav-tabs > li.active > a,
  .with-nav-tabs.panel-success .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > li.active > a:focus {
    color: #3c763d;
    background-color: #fff;
    border-color: #d6e9c6;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #dff0d8;
      border-color: #d6e9c6;
  }
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #3c763d;   
  }
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #d6e9c6;
  }
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-success .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      color: #fff;
      background-color: #3c763d;
  }
  /********************************************************************/
  /*** PANEL INFO ***/
  .with-nav-tabs.panel-info .nav-tabs > li > a,
  .with-nav-tabs.panel-info .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > li > a:focus {
    color: #31708f;
  }
  .with-nav-tabs.panel-info .nav-tabs > .open > a,
  .with-nav-tabs.panel-info .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-info .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > li > a:focus {
    color: #31708f;
    background-color: #bce8f1;
    border-color: transparent;
  }
  .with-nav-tabs.panel-info .nav-tabs > li.active > a,
  .with-nav-tabs.panel-info .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > li.active > a:focus {
    color: #31708f;
    background-color: #fff;
    border-color: #bce8f1;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #d9edf7;
      border-color: #bce8f1;
  }
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #31708f;   
  }
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #bce8f1;
  }
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-info .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      color: #fff;
      background-color: #31708f;
  }
  /********************************************************************/
  /*** PANEL WARNING ***/
  .with-nav-tabs.panel-warning .nav-tabs > li > a,
  .with-nav-tabs.panel-warning .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > li > a:focus {
    color: #8a6d3b;
  }
  .with-nav-tabs.panel-warning .nav-tabs > .open > a,
  .with-nav-tabs.panel-warning .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-warning .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > li > a:focus {
    color: #8a6d3b;
    background-color: #faebcc;
    border-color: transparent;
  }
  .with-nav-tabs.panel-warning .nav-tabs > li.active > a,
  .with-nav-tabs.panel-warning .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > li.active > a:focus {
    color: #8a6d3b;
    background-color: #fff;
    border-color: #faebcc;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #fcf8e3;
      border-color: #faebcc;
  }
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #8a6d3b; 
  }
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #faebcc;
  }
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-warning .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      color: #fff;
      background-color: #8a6d3b;
  }
  /********************************************************************/
  /*** PANEL DANGER ***/
  .with-nav-tabs.panel-danger .nav-tabs > li > a,
  .with-nav-tabs.panel-danger .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > li > a:focus {
    color: #a94442;
  }
  .with-nav-tabs.panel-danger .nav-tabs > .open > a,
  .with-nav-tabs.panel-danger .nav-tabs > .open > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > .open > a:focus,
  .with-nav-tabs.panel-danger .nav-tabs > li > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > li > a:focus {
    color: #a94442;
    background-color: #ebccd1;
    border-color: transparent;
  }
  .with-nav-tabs.panel-danger .nav-tabs > li.active > a,
  .with-nav-tabs.panel-danger .nav-tabs > li.active > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > li.active > a:focus {
    color: #a94442;
    background-color: #fff;
    border-color: #ebccd1;
    border-bottom-color: transparent;
  }
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu {
      background-color: #f2dede; /* bg color */
      border-color: #ebccd1; /* border color */
  }
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > li > a {
      color: #a94442; /* normal text color */  
  }
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > li > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > li > a:focus {
      background-color: #ebccd1; /* hover bg color */
  }
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > .active > a,
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > .active > a:hover,
  .with-nav-tabs.panel-danger .nav-tabs > li.dropdown .dropdown-menu > .active > a:focus {
      color: #fff; /* active text color */
      background-color: #a94442; /* active bg color */
  }
</style>

<div class="container">
  <%# header 1 %>
  <div class="row text-center">
    <div class="col-12">
      <h2><%= @current_user.first_name.titleize %>'s Dashboard</h2>
    </div>
  </div>

  <%# header 2 %>
  <div class="row text-center">
    <div class="col-3 offset-4 col-lg-2 offset-lg-5 mt-5 mb-5">
      <%= select_tag "pets", options_for_select(@pets.map{|p|[p.name, p.id]} << ["Select", -1], -1) %>
    </div>
  </div>

  <%# Body %>
  <div class="row">
    <div class="col-6 text-center event_form" style="display: none">
      <div class="row">
        <div class="p-2 mt-5 mb-5 border event-panel">
          <div class="row text-center">
            <h4 class="col-12">Add New Event</h4>
            <hr class="col-12" />
          </div>
          <%= render "event/form", event: Event.new %>
        </div>
      </div>
      <div class="row mb-5 charts" style="display: none;">
        <ul class="nav nav-tabs col-12" id="chartTabs">
          <li class="nav-tab chart active" id="potties-tab">Potties</li>
          <li class="nav-tab chart" id="poos-tab">Poos</li>
          <li class="nav-tab chart" id="pees-tab">Pees</li>
        </ul>
        <div class="tab-content col-12 border" id="myTabContent">
          <div id="chart-body" class="col-12">
            <div id="pet-chart" class="pet-chart"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6" id="pet-info" style="display: none;">
    </div>
  </div>
</div>